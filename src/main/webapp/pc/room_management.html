<!--
  Created by fun on 2018/1/23.
-->
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta charset="utf-8">
    <meta name="renderer" content="webkit|ie-comp|ie-stand">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no" />
    <link rel="Shortcut Icon" href="favicon.ico" />

    <link rel="stylesheet" href="static/h-ui/css/H-ui.min.css" />
    <link rel="stylesheet" href="lib/layui/css/layui.css">
    <link rel="stylesheet" href="static/h-ui.admin/css/H-ui.admin.css" />
    <link rel="stylesheet" href="lib/Hui-iconfont/1.0.8/iconfont.css" />
    <link rel="stylesheet" href="css/myCss.css">
    <link rel="stylesheet" href="css/pcCss.css">
    <style>

    </style>
</head>

<body style="background:#65A6EA;width:1254px;" class="ifram">
    <div class="wrapper-container roomManagement">
        <!--搜索框-->
        <div class="search-box">
            
            <input class="isPhone" type="text" placeholder="请输入用户姓名" />
            <button class="searchBtn">搜索</button>
            <button class="addBtn">新建</button>
        </div>
        <!--table数据-->
        <div class="table-box">
            <div class="table-head">
            </div>
            <div class="table-body">
            </div>
        </div>
        <!--分页-->
        <div id="page" style="text-align:center;margin-top:30px;width:100%;"></div>
    </div>

	<!--新增房子-->
    <div class="add_mask" id="add_mask">
        <div class="mask_contain">
            <div class="mask_top">新增房间<span class="close1">&times;</span></div>
            <div class="form" style="padding-bottom:0;">
                <div>
                	<span>所在小区：</span>
                	<select id="add_buildingSlt" style="width:172px;">
                		<option value="-1">请选择小区</option>
                	</select>
                </div><br>
                <div>
                	<span>单元号：</span>
                	<select id="add_unitSlt" style="width:172px;">
                		<option value="-1">请选择单元</option>
                	</select>
                </div><br>
                <div>
                	<span>楼层号：</span>
                	<select id="add_floorSlt" style="width:172px;">
                		<option value="-1">请选择楼层</option>
                	</select>
                </div><br>
                <div>
                	<span>房子类型：</span>
                	<select id="add_roomTypeSlt" style="width:172px;">
                		<option value="1">居民</option>
	                	<option value="2">商业</option>
	                	<option value="3">办公</option>
	                	<option value="4">餐饮</option>
                	</select>
                </div><br> 
                <div><span>房间编号：</span><input id="roomNo" type="text" placeholder="请输入房间编号"></div><br>
                <div><span>房间名称：</span><input id="roomName" type="text" placeholder="请输入房间名称"></div><br>
                <div><span>房间户型：</span><input id="houseType" type="text" placeholder="请输入房间户型"></div><br>
                <div><span>房间面积：</span><input id="houseType" type="number" placeholder="请输入房间面积"></div><br>
                
            </div>
            <div class="mask_btn"><button class="comfire" id="add_room">确认</button><button class="cansle">取消</button></div>
        </div>
    </div>

    <script src="lib/jquery/1.9.1/jquery.min.js"></script>
    <!----<script type="text/javascript" src="lib/layer/2.4/layer.js"></script>-------->
    <script type="text/javascript" src="lib/layui/layui.js"></script>
    <script type="text/javascript" src="js/WFang.js"></script>
    <script type="text/javascript" src="static/h-ui/js/H-ui.min.js"></script>
    <script type="text/javascript" src="static/h-ui.admin/js/H-ui.admin.js"></script>
    <script>
        layui.use(['layer', 'laypage'], function() {
            var layer = layui.layer;
            var laypage = layui.laypage;
  
            load_building();

            function load_building() {

                var data = {
                    "pageNum": 1,
                    "pageSize": 100,
                };

                WFang("building/queryListWithPage", function(arr) {
                    var datarow = "";
                    if (arr.status == false) {
                        
                    } else {
                        datarow += '<option value="-1">请选择小区</option>';
                        for (var i = 0; i < arr.data.list.length; i++) {
                            datarow += '<option value=' + arr.data.list[i].id+'>'
                                    + arr.data.list[i].buildingName + '</option>';
                        }
                    }
                    $('#add_buildingSlt').html(datarow);
                    $('#m_buildingSlt').html(datarow);  
                }, data, 'postForm');

            }

            $("#add_buildingSlt").change(function() {  
                var buildingId = $('#add_buildingSlt').find("option:selected").val();
                // 获取楼栋信息
                WFang("building/queryById/" + buildingId, function(arr) {
                    var datarow_unit = "";
                    var datarow_floor = "";
                    if (arr.status == false) {
                        
                    } else {
                        datarow_unit += '<option value="-1">请选择单元</option>';
                        for (var i = 1; i <= arr.data.unitSize; i++) {
                            datarow_unit += '<option value=' + i +'>'
                                    + i + '单元</option>';
                        }

                        datarow_floor += '<option value="-1">请选择楼层</option>';
                        for (var i = 1; i <= arr.data.floorSize; i++) {
                            datarow_floor += '<option value=' + i +'>'
                                    + i + '层</option>';
                        }
                    }
                    $('#add_unitSlt').html(datarow_unit);
                    $('#add_floorSlt').html(datarow_floor);  
                }, '', 'postForm');
            }) 

            //页面渲染 
            var name = '';
            getData(1, name);

            function getData(pageNo, name) {
                var pageNo = pageNo;
                var pageSize = 8;

                var data = {
                    "pageNum": pageNo,
                    "pageSize": pageSize
                };
                WFang("room/queryListWithPage", function(arr) {
                    // console.log(arr);
                    if (arr.status == false) {
                        layer.msg(arr.message);
                    } else {
                        //分页
                        laypage.render({
                            elem: 'page', //容器
                            pages: arr.data.pages, // 总页数
                            count: arr.data.total, //总条数
                            theme: '#0D3D89', //主题
                            last: '末页', //最后一页
                            limit: '8', //每页条数限制
                            curr: arr.data.pageNum, //当前页
                            prev: '<em><</em>', //上一页
                            next: '<em>></em>', //下一页
                            layout: ['count', 'prev', 'page', 'next', 'skip'],
                            jump: function(obj, first) {
                                //obj包含了当前分页的所有参数，比如：
                                if (!first) {
                                    addStas = 0;
                                    getData(obj.curr); //得到当前页，以便向服务端请求对应页的数据。
                                }
                            }
                        });
                        var html = '',
                            html1 = '',
                            wStatus = '',
                            nStatus = '',
                            lock = '',
                            color = ''
                            roomType = '';
                        if (arr.data.list == '' || arr.data.list == null) {
                            layer.msg('暂无数据!');
                        } else {
                            html1 = '<span>热站名称</span>' +
                                '<span>小区名称</span>' +
                                '<span>楼栋名称</span>' +
                                '<span>房间号</span>' +
                                '<span>户型</span>' +
                                '<span>面积（㎡）</span>' +
                                '<span>房间类型</span>' +
                                '<span>操作</span>';
                            $('.table-head').html(html1);
                            
                            for (var i = 0; i < arr.data.list.length; i++) {

                                switch(arr.data.list[i].roomType) {
                                    case 1 :
                                        roomType = '居民';
                                        break;
                                    case 2 :
                                        roomType = '商业';
                                        break;
                                    case 3 :
                                        roomType = '办公';
                                        break;
                                    case 4 :
                                        roomType = '餐饮';
                                        break;
                                }

                                html += '<div class="div-box">' +
                                    '<span>' + arr.data.list[i].siteName + '</span>' +
                                    '<span>' + arr.data.list[i].areaName + '</span>' +
                                    '<span>' + arr.data.list[i].buildingName + '</span>' +
                                    '<span>' + arr.data.list[i].roomName + '</span>' +
                                    '<span>' + arr.data.list[i].houseType + '</span>' +
                                    '<span>' + arr.data.list[i].acreage + '</span>' +
                                    '<span>' + roomType + '</span>' +
                                    '<span>' +
                                    '<a class="a-edit" data-userId="' + arr.data.list[i].id + '" href="javascript:void (0);">编辑</a>' +
                                    '<a class="a-deviceInfo" data-userId="' + arr.data.list[i].id + '" href="javascript:void (0);">设备明细</a>' +
                                    '<a class="a-mark" data-userId="' + arr.data.list[i].id + '" href="javascript:void (0);">服务印记</a>' +
                                    '</span>' +
                                    '</div>';
                            }
                            
                           $('.table-body').html(html);
                        }
                    }

                }, data, 'postForm')
            }
            
            /***********************关闭添加弹框*****************************/
            $('body').on("click",".cansle",function(){
			    $(".add_mask").hide();
			});
            
            /***********************关闭添加弹框*****************************/
            $('body').on("click",".close1",function(){
			    $(".add_mask").hide();
			});
            
            /***********************添加房间弹框*****************************/
            $('body').on('click', '.addBtn', function() {
	    		$("#add_mask").show();
	    		//$("#realname").val("");
	    		//$("#phone").val("");
	    		//$("#add_password").val("");
	    		//$("#add_repassword").val("");
			});
			
            /***********************添加房间*****************************/
            $("body").on("click","#add_room",function(){
	    		var realname = $("#realname").val();
	    		var phone = $("#phone").val();
	    		var roleId = $("#add_roleSlt").val();
	    		var add_password = $("#add_password").val();
	    		var add_repassword = $("#add_repassword").val();
	    		var param = {'roleId':roleId};
	    		var serverApi = "";
		        if (typeof(realname)==='undefined' || realname=='' || realname=='null'){
		        	layer.msg("请输入房间名称~");
		            // $(".add_mask").show();
		            return;
		        } else{
		            param['realname'] = realname;
		        }
		        if (typeof(phone)==='undefined' || phone=='' || phone=='null'){
		                //Toast('请填写抄表员姓名~');
		                //$(".add_mask").show();
		                //return;
		        } else{
		            param['phone'] = phone;
		        }
		        
		        if (typeof(add_password)==='undefined' || add_password=='' || add_password=='null'){
		                Toast('请填写密码~');
		                $(".add_mask").show();
		                return;
		        } else{
		            param['password'] = add_password;
		        }
	    		
	    		if (add_password != add_repassword){
		            Toast('填写的密码与确认密码不一致哦');
		            $(".add_mask").show();
		            return;
		        } else {
		        	param['repassword'] = add_repassword;
		        }
		        
		        if (roleId == '2') {
		        	//　 添加抄表员
		        	serverApi = ApiConf.add_user_chao;
		        } else if (roleId == '3') {
		        	serverApi = ApiConf.add_user_shen;
		        	/* 获取审核组Id */
		        	var groupId = "";
		        	$('input[name="add_group"]:checked').each(function(index) {
		        		if (index == 0) {
		        			groupId = $(this).val();
		        		} else {
		        			groupId = groupId + '@' + $(this).val()
		        		}
		        	})
		        	param['groupId'] = groupId;
		        } else {
		        	Toast('请选择要添加的用户角色~');
		        }
		             
		        
		        CfConn(serverApi, function(data) {
	    			
	    			Toast('添加用户成功成功了~');
	    			$(".add_mask").hide();
	    			if (pageSpan == pageSize) {
	    				loaddata(true);
	    			} else {
	    				pageNo = pageNo - 1;
	    				loaddata(true);
	    			}
	    		}, param , 
	    		  {uid:window.sessionStorage.getItem(UrlConf.tk_uid)} ,
	    		  function(error, msg) {
	    		  	Toast(msg);
	    		  	$(".add_mask").show();
	    		  });
	    	});
            
            /***********************根据名称查询*****************************/
            $('body').on('click', '.searchBtn', function() {
                var name = $('.isPhone').val();
                getData(1, name);
            });
            /***********************编辑地理位置*****************************/
            //自定义变量状态  0-不存在添加框 1-已存在
            var addStas = '0';
            $('body').on('click', '.a-edit', function() {
                if (addStas == '1') {
                    layer.msg('一次只能编辑一项！');
                    return;
                } else {
                    //改变自定义变量状态
                    addStas = '1';
                    var userId = $(this).attr('data-userId');
                    $(this).html('保存');
                    $(this).removeClass('a-edit').addClass('a-save');
                    $($($(this).parent().parent().children()[6]).children()[0]).children().addClass('edit-address');
                    var alladd = $($($(this).parent().parent().children()[6]).children()[0]).attr('title');
                    $('.edit-address').attr('readonly', false);
                    $('.edit-address').val(alladd);
                    $('.edit-address').attr('style', 'color:#a0a0a0;');
                }
            });
            $('body').on('click', '.a-save', function() {
                var userId = $(this).attr('data-userId');
                var address = $('.edit-address').val().trim();
                edit(userId, address);
            });

            function edit(userId, address) {
                var pageNo = $('.layui-input').val();
                var data = {
                    "userId": userId,
                    "address": address
                };
                WFang("Device/updateLocation", function(arr) {
                    if (arr.status == false) {
                        layer.msg(arr.message);
                        console.log($('.a-save').html());
                    } else {
                        layer.msg(arr.message);

                        setTimeout(function() {
                            //改变自定义变量状态
                            addStas = '0';
                            getData(pageNo, name);
                        }, 1800);
                    }
                }, data, 'postForm')
            }
        });
    </script>
</body>

</html>